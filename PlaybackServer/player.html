<!DOCTYPE html>
<html lang="en">
 <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>SyncSpin Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

 </head>
 <body>
  <div class="container">
    <form>
     <input id = 'songID' type="text" >
     <button id= 'submitID' type="button" class = "btn btn-default btn-md">Submit New Track id</button>
    </form>
    <div class=".col-md-8">
    <div class="player">
    <button id="play" type="button" class="btn btn-default btn-lg">
  <span class="glyphicon glyphicon-play"></span> Play
    <button id="pause" type="button" class="btn btn-default btn-lg">
  <span class="glyphicon glyphicon-pause"></span> Pause
    <button id="stop" type="button" class="btn btn-default btn-lg">
  <span class="glyphicon glyphicon-stop"></span> Stop
  <button id="next" type="button" class="btn btn-default btn-lg">
    <span class="glyphicon glyphicon-fast-forward"></span> Next
  </div>
  <div id = "playtable">
  </div>

</div>
</button>
   
  </div>
  <script src="bootstrap/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="bootstrap/js/bootstrap.min.js"></script>
  <script src="http://bam.cdn.beatsmusic.com/bam-1.0.2.min.js"></script>
  <script>
    function getJsonFromUrl() {
        var query = location.search.substr(1);
        var result = {};
        query.split("&").forEach(function(part) {
        var item = part.split("=");
        result[item[0]] = decodeURIComponent(item[1]);
    });
    return result;
    }

    var bam = new BeatsAudioManager("SyncSpin");
    bam.on("ready", handleReady);
    bam.on("error", handleError);
    //bam.on("ended", handleEnded);
    function handleReady(value) { 
      bam.clientId = "ytuyn29p9e5b4udwtgwmughe";
      token = getJsonFromUrl().access_token;
      //console.log(window.token)
      bam.authentication = {
        access_token:token, 
        user_id:"liam.t.sargent"
      };
      bam.identifier = "tr82702885";
      bam.autoplay = true;
      bam.load();
      };
function handleError(value) {
    console.log("Error: " + value);
    switch(value){
        case "auth":
        console.log("auth error = ")
        // Beats Music API auth error (401)
        break;
        case "connectionfailure":
        // audio stream connection failure
        break;
        case "apisecurity":
        // Beats Music API crossdomain error
        break;
        case "streamsecurity":
        // audio stream crossdomain error
        break;
        case "streamio":
        // audio stream io error
        break;
        case "apiio":
        // Beats Music API io error getting track data
        break;
        case "flashversion":
        // flash version too low or not installed
        break;
    }
};

function setUID(UID){
  window.UID = UID;
}

function getSentence(place,activity,people,genre,timezone){
  var token = getJsonFromUrl().access_token;
    $.ajax({url:'https://partner.api.beatsmusic.com/v1/api/me',
         type: "GET",
         headers: {Authorization: 'Bearer '+ token},
         dataType:'json',
          success: function (data) {
            playlistHolder.initPlaylist(data.result.user_context,place,activity,people,genre,timezone);
          }
       });
}

var playlistHolder = {
    playedSongs:[],
    queuedSongs:[],
    initPlaylist: function(user_id,place,activity,people,genre,timezone){
      var token = getJsonFromUrl().access_token;
      $.ajax({
        type: "POST",
        url: 'https://partner.api.beatsmusic.com/v1/api/users/'+user_id+'/recs/the_sentence?place='+place+'&activity='
        +activity+'&people='+people+'&genre='+genre+'&time_zone='+timezone+'&access_token='+token,
        /*data: {'place':place,
               'activity':activity,
               'people':people,
               'genre':genre,
               'time_zone':timezone,
               'access_token':window.token
              },*/
        dataType: 'json',
        success: function(data) {
          addToPlaylist(data)  
        }
      });
    },
}; 

function addToPlaylist(array){
  for (ii =0; ii<array.length; ii++){
    playlistHolder.queuedSongs.push(array[ii].id);
    console.log(array[ii].id);
    }   
}

getSentence('178','61','131','32','-0500');

function playNextSong() {
    console.log(playlistHolder.queuedSongs.splice(0,1));
    nextup = playlistHolder.queuedSongs.splice(0,1);
    bam.identifier=nextup;
    bam.load();
};

function loadSong(trackID) {
  playlistHolder.queuedSongs.push(trackID);
}

function playSong() {
    bam.play()
};

var $playtable = $( "<table></table>" );

for ( var i = 0; i <playlistHolder.queuedSongs.length; i++ ) {
    var emp = playlistHolder.queuedSongs[i];
    var $line = $( "<tr></tr>" );
    $line.append( $( "<td></td>" ).html( emp ) );
    $playtable.append( $line );
}
$playtable.appendTo( $( "#playtable" ) );

$( "#play" ).click(function() {
    bam.play()
});
$( "#pause" ).click(function() {
    bam.pause()
});
$( "#stop" ).click(function() {
    bam.stop()
});
$( "#next" ).click(function() {
    playNextSong();
});
$("#submitID").click(function(){
    loadSong($("#songID").val());
});

  </script>
 </body>
</html>